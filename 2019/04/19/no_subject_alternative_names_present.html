<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>&quot;No subject alternative names present&quot; on New JDK - Jason Joo</title>
        <script>if (top !== self) top.location = self.location;</script>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0" />
        <link rel="stylesheet" href="/static/style.css?v=2c4d4" />
        <link rel="stylesheet" href="/static/pygments.css?v=c6adc" />
        
        <link rel="alternate" type="application/rss+xml" href="/feed.xml" title="Jason Joo" />
        <!--[if lt IE 9]>
        <script type="text/javascript" src="/static/html5shiv.js?v=9a10c"></script>
        <![endif]-->
        
        
<link rel="canonical" href="/2019/04/19/no_subject_alternative_names_present.html" />


    </head>
    <body>
        <header id="header">
            <h1 id="brand"><a href="/">Jason Joo</a></h1>
            <nav id="nav" role="navigation">
                
                <a href="/">Home</a>
                <a href="/about">About</a>
            </nav>
        </header>

        <div id="main">
            <div class="container"><div class="hentry">
    <h1 class="entry-title">&quot;No subject alternative names present&quot; on New JDK</h1>
    <div class="entry-meta">
        <time class="updated" datetime="2019-04-19T00:00:00+08:00" pubdate>
            <a href="/2019/">2019-04-19</a>
        </time>
        <span class="author vcard">
            by <span class="fn">Jason</span>
        </span>
    </div>
    <div class="entry-content">
        <h1 id="toc_0">Abstract</h1>
<p>In newer JDK implemetation(maybe JDK &gt;= 8) you may suffer a CertificateException of &ldquo;No subject alternative names present&rdquo; when trying to create a TLS/SSL connection before you make Encrypted/HTTPS/LDAPS request.  </p>
<p>A new property named <code>com.sun.jndi.ldap.object.disableEndpointIdentification</code> has been introduced in new JDK versions (tested in JDK 11 compared to JDK 8) to decide whether make additional verification of endpoint name to certificate provided by server. The problem is that it will turn on by default. So if you suffering the problem you may try one of the solutions below:  </p>

<ol>
<li>Set the property of <code>com.sun.jndi.ldap.object.disableEndpointIdentification</code> to false.</li>
<li>When you make plain TLS connections don&#39;t use <code>sslParameters.setEndpointIdentificationAlgorithm(&quot;HTTPS&quot;);</code> for your SSLSocket. (Not for LDAPS/HTTPS)</li>
<li>When you use <code>HttpsURLConnection</code> you can add your custom hostname verifier by <code>setDefaultHostnameVerifier</code>.</li>
<li>Sign the server certificate with SAN information in extension.(<strong>Recommended</strong>)</li>
</ol>
<p>Please noted that it&#39;s totally a different issue compared to <code>Self Signed Certificate Issue</code>.</p>

<h1 id="toc_1">First Meet It</h1>
<p>One of our project choose <code>docker-java</code>[1] enabling operations on remote <code>dockerd</code>. Connection is encrypted by TLS 1.2.  </p>
<p>Everything goes right before we switch the commend implementation from <code>Jersey</code> to <code>NettyDockerCmdExecFactory</code>. Because <code>ExeStartCmd</code> doesn&#39;t support stdin stream when using <code>Jersey</code> we switch into netty implementation.  </p>
<p>Then we meet the exception <code>No subject alternative names present</code> and can&#39;t communicate to server anymore. We are quite sure the connection can be established and encrypted smoothly when using jersey backend.  </p>
<p>After hours&#39; research we found that the exception was mainly targeting to the unsuitable certificate the server gave out. SSLContext will do additional hostname(or calling endpoint) verification after passed through <code>TrustManager[]</code>. Logic is located in <code>sun.security.util.HostnameChecker</code> with two form: <code>IP</code> and <code>Domain</code> matching with certificate(In this case it&#39;s IP).  </p>
<p>Checker will fetch <code>SAN</code> (Subject Alternative Names) from extension of certificate and compare it with the server actually ip address. Extension structure is defined with version 3 of X509 but our certificate is generated by some old scripts in version 1 and only have <code>CN=xxx.xxx.xxx.xxx</code> in Subject field. So the logic will fail and throw the exception.</p>
<p>Because the <code>jersey</code> backend works correctly so I guess it&#39;s not a required verification. Working a little more I figure out the key statement:  </p>
<div class="highlight"><pre><span></span><span class="n">sslParameters</span><span class="p">.</span><span class="na">setEndpointIdentificationAlgorithm</span><span class="p">(</span><span class="s">&quot;HTTPS&quot;</span><span class="p">);</span>
</pre></div>
<p>The netty backend adds the specific parameter manually which will enable the additional verification.  </p>
<p>There are two sulutions:</p>

<ol>
<li>Remove the line of <code>setEndpointIdentificationAlgorithm</code></li>
<li>Regenerate the certificate using version 3. Add the SAN information required in extension part.(Recommended)</li>
</ol>
<p>Knowing the reasons we regenerated the certificate following the rules.  </p>

<h1 id="toc_2">Meet It Again</h1>
<p>Things seem like going well but the same error happens again two days later. The affected logic is the connection of LDAP(Using SSL). It&#39;s strange because it works well before.  </p>
<p>Fortunately we can debug it in source code level (package <code>sun.security</code>) because we change the JDK to version 11 days ago. After some more time we arrived:  </p>
<p><code>sun.security.util.HostnameChecker</code>  </p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">matchIP</span><span class="p">(</span><span class="n">String</span> <span class="n">expectedIP</span><span class="p">,</span> <span class="n">X509Certificate</span> <span class="n">cert</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="n">CertificateException</span> <span class="p">{</span>
        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">subjAltNames</span> <span class="o">=</span> <span class="n">cert</span><span class="p">.</span><span class="na">getSubjectAlternativeNames</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">subjAltNames</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">CertificateException</span>
                                <span class="p">(</span><span class="s">&quot;No subject alternative names present&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">List</span><span class="o">&lt;?&gt;</span> <span class="n">next</span> <span class="p">:</span> <span class="n">subjAltNames</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// For IP address, it needs to be exact match</span>
            <span class="k">if</span> <span class="p">(((</span><span class="n">Integer</span><span class="p">)</span><span class="n">next</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)).</span><span class="na">intValue</span><span class="p">()</span> <span class="o">==</span> <span class="n">ALTNAME_IP</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">String</span> <span class="n">ipAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">next</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">expectedIP</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="n">ipAddress</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">// compare InetAddress objects in order to ensure</span>
                    <span class="c1">// equality between a long IPv6 address and its</span>
                    <span class="c1">// abbreviated form.</span>
                    <span class="k">try</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">InetAddress</span><span class="p">.</span><span class="na">getByName</span><span class="p">(</span><span class="n">expectedIP</span><span class="p">).</span><span class="na">equals</span><span class="p">(</span>
                                <span class="n">InetAddress</span><span class="p">.</span><span class="na">getByName</span><span class="p">(</span><span class="n">ipAddress</span><span class="p">)))</span> <span class="p">{</span>
                            <span class="k">return</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">UnknownHostException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">SecurityException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">CertificateException</span><span class="p">(</span><span class="s">&quot;No subject alternative &quot;</span> <span class="o">+</span>
                        <span class="s">&quot;names matching &quot;</span> <span class="o">+</span> <span class="s">&quot;IP address &quot;</span> <span class="o">+</span>
                        <span class="n">expectedIP</span> <span class="o">+</span> <span class="s">&quot; found&quot;</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>
<p>Oh it enters into the <code>matchIP</code> too like we were in the first case. But the stack may be different. After more debugging:  </p>
<p><code>sun.security.ssl.SSLContextImpl</code></p>
<div class="highlight"><pre><span></span><span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">checkServerTrusted</span><span class="p">(</span><span class="n">X509Certificate</span><span class="o">[]</span> <span class="n">chain</span><span class="p">,</span> <span class="n">String</span> <span class="n">authType</span><span class="p">,</span>
            <span class="n">SSLEngine</span> <span class="n">engine</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">CertificateException</span> <span class="p">{</span>
        <span class="n">tm</span><span class="p">.</span><span class="na">checkServerTrusted</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">authType</span><span class="p">);</span>
        <span class="n">checkAdditionalTrust</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">authType</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkAdditionalTrust</span><span class="p">(</span><span class="n">X509Certificate</span><span class="o">[]</span> <span class="n">chain</span><span class="p">,</span> <span class="n">String</span> <span class="n">authType</span><span class="p">,</span>
                <span class="n">Socket</span> <span class="n">socket</span><span class="p">,</span> <span class="kt">boolean</span> <span class="n">isClient</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">CertificateException</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">socket</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">socket</span><span class="p">.</span><span class="na">isConnected</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                                    <span class="n">socket</span> <span class="k">instanceof</span> <span class="n">SSLSocket</span><span class="p">)</span> <span class="p">{</span>

            <span class="n">SSLSocket</span> <span class="n">sslSocket</span> <span class="o">=</span> <span class="p">(</span><span class="n">SSLSocket</span><span class="p">)</span><span class="n">socket</span><span class="p">;</span>
            <span class="n">SSLSession</span> <span class="n">session</span> <span class="o">=</span> <span class="n">sslSocket</span><span class="p">.</span><span class="na">getHandshakeSession</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">CertificateException</span><span class="p">(</span><span class="s">&quot;No handshake session&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// check endpoint identity</span>
            <span class="n">String</span> <span class="n">identityAlg</span> <span class="o">=</span> <span class="n">sslSocket</span><span class="p">.</span><span class="na">getSSLParameters</span><span class="p">().</span>
                                        <span class="n">getEndpointIdentificationAlgorithm</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">identityAlg</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">identityAlg</span><span class="p">.</span><span class="na">length</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">String</span> <span class="n">hostname</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="na">getPeerHost</span><span class="p">();</span>
                <span class="n">X509TrustManagerImpl</span><span class="p">.</span><span class="na">checkIdentity</span><span class="p">(</span>
                                    <span class="n">hostname</span><span class="p">,</span> <span class="n">chain</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="n">identityAlg</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// try the best to check the algorithm constraints</span>
            <span class="n">AlgorithmConstraints</span> <span class="n">constraints</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ProtocolVersion</span><span class="p">.</span><span class="na">useTLS12PlusSpec</span><span class="p">(</span><span class="n">session</span><span class="p">.</span><span class="na">getProtocol</span><span class="p">()))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="k">instanceof</span> <span class="n">ExtendedSSLSession</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">ExtendedSSLSession</span> <span class="n">extSession</span> <span class="o">=</span>
                                    <span class="p">(</span><span class="n">ExtendedSSLSession</span><span class="p">)</span><span class="n">session</span><span class="p">;</span>
                    <span class="n">String</span><span class="o">[]</span> <span class="n">peerSupportedSignAlgs</span> <span class="o">=</span>
                            <span class="n">extSession</span><span class="p">.</span><span class="na">getLocalSupportedSignatureAlgorithms</span><span class="p">();</span>

                    <span class="n">constraints</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SSLAlgorithmConstraints</span><span class="p">(</span>
                                    <span class="n">sslSocket</span><span class="p">,</span> <span class="n">peerSupportedSignAlgs</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">constraints</span> <span class="o">=</span>
                            <span class="k">new</span> <span class="n">SSLAlgorithmConstraints</span><span class="p">(</span><span class="n">sslSocket</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">constraints</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SSLAlgorithmConstraints</span><span class="p">(</span><span class="n">sslSocket</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">checkAlgorithmConstraints</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">isClient</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
<p>It shows that the verification is relying the value of <code>sslSocket.getSSLParameters().getEndpointIdentificationAlgorithm();</code>.  </p>
<p>But we don&#39;t set it to any value when creating the ssl socket and printing its value also shows to <code>null</code>:  </p>
<div class="highlight"><pre><span></span><span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Socket</span> <span class="nf">createSocket</span><span class="p">(</span><span class="n">String</span> <span class="n">string</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">UnknownHostException</span> <span class="p">{</span>
        <span class="n">SSLSocketImpl</span> <span class="n">ssl</span> <span class="o">=</span> <span class="p">(</span><span class="n">SSLSocketImpl</span><span class="p">)</span><span class="n">socketFactory</span><span class="p">.</span><span class="na">createSocket</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="n">SSLParameters</span> <span class="n">param</span> <span class="o">=</span> <span class="n">ssl</span><span class="p">.</span><span class="na">getSSLParameters</span><span class="p">();</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="na">getEndpointIdentificationAlgorithm</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">ssl</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
<p>Console output:</p>

<pre><code>null</code></pre>
<p>So who sets it? After deeper tracing I arrived:  </p>
<p><code>com.sun.jndi.ldap.Connection</code></p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="n">Socket</span> <span class="nf">createSocket</span><span class="p">(</span><span class="n">String</span> <span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">String</span> <span class="n">socketFactory</span><span class="p">,</span>
            <span class="kt">int</span> <span class="n">connectTimeout</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>

        <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">socketFactory</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// create the factory</span>

            <span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;unchecked&quot;</span><span class="p">)</span>
            <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">SocketFactory</span><span class="o">&gt;</span> <span class="n">socketFactoryClass</span> <span class="o">=</span>
                <span class="p">(</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">SocketFactory</span><span class="o">&gt;</span><span class="p">)</span><span class="n">Obj</span><span class="p">.</span><span class="na">helper</span><span class="p">.</span><span class="na">loadClass</span><span class="p">(</span><span class="n">socketFactory</span><span class="p">);</span>
            <span class="n">Method</span> <span class="n">getDefault</span> <span class="o">=</span>
                <span class="n">socketFactoryClass</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&quot;getDefault&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">&lt;?&gt;[]</span><span class="p">{});</span>
            <span class="n">SocketFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="p">(</span><span class="n">SocketFactory</span><span class="p">)</span> <span class="n">getDefault</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span><span class="p">{});</span>

            <span class="c1">// create the socket</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">connectTimeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

                <span class="n">InetSocketAddress</span> <span class="n">endpoint</span> <span class="o">=</span>
                        <span class="n">createInetSocketAddress</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

                <span class="c1">// unconnected socket</span>
                <span class="n">socket</span> <span class="o">=</span> <span class="n">factory</span><span class="p">.</span><span class="na">createSocket</span><span class="p">();</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Connection: creating socket with &quot;</span> <span class="o">+</span>
                            <span class="s">&quot;a timeout using supplied socket factory&quot;</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="c1">// connected socket</span>
                <span class="n">socket</span><span class="p">.</span><span class="na">connect</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">connectTimeout</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// continue (but ignore connectTimeout)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">socket</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Connection: creating socket using &quot;</span> <span class="o">+</span>
                        <span class="s">&quot;supplied socket factory&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="c1">// connected socket</span>
                <span class="n">socket</span> <span class="o">=</span> <span class="n">factory</span><span class="p">.</span><span class="na">createSocket</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">connectTimeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

                    <span class="n">InetSocketAddress</span> <span class="n">endpoint</span> <span class="o">=</span> <span class="n">createInetSocketAddress</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

                    <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="p">();</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Connection: creating socket with &quot;</span> <span class="o">+</span>
                            <span class="s">&quot;a timeout&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="n">socket</span><span class="p">.</span><span class="na">connect</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">connectTimeout</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// continue (but ignore connectTimeout)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">socket</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Connection: creating socket&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="c1">// connected socket</span>
                <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// For LDAP connect timeouts on LDAP over SSL connections must treat</span>
        <span class="c1">// the SSL handshake following socket connection as part of the timeout.</span>
        <span class="c1">// So explicitly set a socket read timeout, trigger the SSL handshake,</span>
        <span class="c1">// then reset the timeout.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">socket</span> <span class="k">instanceof</span> <span class="n">SSLSocket</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">SSLSocket</span> <span class="n">sslSocket</span> <span class="o">=</span> <span class="p">(</span><span class="n">SSLSocket</span><span class="p">)</span> <span class="n">socket</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_HOSTNAME_VERIFICATION_DISABLED</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">SSLParameters</span> <span class="n">param</span> <span class="o">=</span> <span class="n">sslSocket</span><span class="p">.</span><span class="na">getSSLParameters</span><span class="p">();</span>
                <span class="n">param</span><span class="p">.</span><span class="na">setEndpointIdentificationAlgorithm</span><span class="p">(</span><span class="s">&quot;LDAPS&quot;</span><span class="p">);</span>
                <span class="n">sslSocket</span><span class="p">.</span><span class="na">setSSLParameters</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">connectTimeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">socketTimeout</span> <span class="o">=</span> <span class="n">sslSocket</span><span class="p">.</span><span class="na">getSoTimeout</span><span class="p">();</span>
                <span class="n">sslSocket</span><span class="p">.</span><span class="na">setSoTimeout</span><span class="p">(</span><span class="n">connectTimeout</span><span class="p">);</span> <span class="c1">// reuse full timeout value</span>
                <span class="n">sslSocket</span><span class="p">.</span><span class="na">startHandshake</span><span class="p">();</span>
                <span class="n">sslSocket</span><span class="p">.</span><span class="na">setSoTimeout</span><span class="p">(</span><span class="n">socketTimeout</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">socket</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
<p>So the last block rely to the value of <code>IS_HOSTNAME_VERIFICATION_DISABLED</code>, and:</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">IS_HOSTNAME_VERIFICATION_DISABLED</span>
            <span class="o">=</span> <span class="n">hostnameVerificationDisabledValue</span><span class="p">();</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">hostnameVerificationDisabledValue</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">PrivilegedAction</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">act</span> <span class="o">=</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span>
                <span class="s">&quot;com.sun.jndi.ldap.object.disableEndpointIdentification&quot;</span><span class="p">);</span>
        <span class="n">String</span> <span class="n">prop</span> <span class="o">=</span> <span class="n">AccessController</span><span class="p">.</span><span class="na">doPrivileged</span><span class="p">(</span><span class="n">act</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prop</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">prop</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">()</span> <span class="o">?</span> <span class="kc">true</span> <span class="p">:</span> <span class="n">Boolean</span><span class="p">.</span><span class="na">parseBoolean</span><span class="p">(</span><span class="n">prop</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>
<p>Things are clear. By default the property <code>com.sun.jndi.ldap.object.disableEndpointIdentification</code> is empty and the value will be set to <code>true</code> which means additional verification will be taken. But why the logic worked correctly before?  </p>
<p>I turn to <code>Open JDK 7/8</code> for source code reference and find they are lack of the final piece of code:  </p>
<div class="highlight"><pre><span></span><span class="c1">// For LDAP connect timeouts on LDAP over SSL connections must treat</span>
        <span class="c1">// the SSL handshake following socket connection as part of the timeout.</span>
        <span class="c1">// So explicitly set a socket read timeout, trigger the SSL handshake,</span>
        <span class="c1">// then reset the timeout.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">socket</span> <span class="k">instanceof</span> <span class="n">SSLSocket</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">SSLSocket</span> <span class="n">sslSocket</span> <span class="o">=</span> <span class="p">(</span><span class="n">SSLSocket</span><span class="p">)</span> <span class="n">socket</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_HOSTNAME_VERIFICATION_DISABLED</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">SSLParameters</span> <span class="n">param</span> <span class="o">=</span> <span class="n">sslSocket</span><span class="p">.</span><span class="na">getSSLParameters</span><span class="p">();</span>
                <span class="n">param</span><span class="p">.</span><span class="na">setEndpointIdentificationAlgorithm</span><span class="p">(</span><span class="s">&quot;LDAPS&quot;</span><span class="p">);</span>
                <span class="n">sslSocket</span><span class="p">.</span><span class="na">setSSLParameters</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">connectTimeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">socketTimeout</span> <span class="o">=</span> <span class="n">sslSocket</span><span class="p">.</span><span class="na">getSoTimeout</span><span class="p">();</span>
                <span class="n">sslSocket</span><span class="p">.</span><span class="na">setSoTimeout</span><span class="p">(</span><span class="n">connectTimeout</span><span class="p">);</span> <span class="c1">// reuse full timeout value</span>
                <span class="n">sslSocket</span><span class="p">.</span><span class="na">startHandshake</span><span class="p">();</span>
                <span class="n">sslSocket</span><span class="p">.</span><span class="na">setSoTimeout</span><span class="p">(</span><span class="n">socketTimeout</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">socket</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
<p>That&#39;s the key point.</p>

<h1 id="toc_3">Conclusion</h1>

<ol>
<li>When you get <code>No subject alternative names present</code> you should make sure the server certificate is in version 3 and has the proper SAN field value in extension.</li>
<li>Related project upgraded from older JDK to JDK11 (JDK9 has not been tested in current case) may hit the problem. You can try to disable it by set property <code>com.sun.jndi.ldap.object.disableEndpointIdentification</code> to <code>false</code>.</li>
<li>For manually created ssl connections you can enable/disable by setting the parameter <code>endpointIdentificationAlgorithm</code> of SSLSocket. Its value can only be <code>SSL</code>/<code>LDAPS</code>. <code>SSL</code> is for all the non-ldap connections.</li>
</ol>
<p>It&#39;s recommended that regenerated the issued certificate using the right properties.</p>

<h1 id="toc_4">Reference</h1>
<p>[1] Java Docker API Client <a href="https://github.com/docker-java/docker-java">github.com/docker-java/docker-java</a></p>

    </div>

    

    <div class="entry-tags">
        <a href="/tag/ssl/">ssl</a><a href="/tag/ldaps/">ldaps</a><a href="/tag/jdk/">jdk</a><a href="/tag/java/">java</a>
    </div>

    
</div></div>
        </div>

        <footer id="footer">
            <hr class="end" />
            
            <p class="copyright">
            <span class="software">
                Powered by <a href="http://lab.lepture.com/liquidluck/">Felix Felicis</a> 3.8.1,
            </span>
            <span class="theme">
                Theme <a href="https://github.com/lepture/liquidluck-theme-moment" rel="nofollow">moment</a> 1.0 by <a href="http://lepture.com">Hsiaoming Yang</a>
            </span>
            </p>
        </footer>
        <script type="text/javascript" src="/static/mobile.js?v=3b6df"></script>
        
    </body>
</html>